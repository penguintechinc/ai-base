name: Build AI Base - NVIDIA

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/ai-inference/**'
      - '.github/workflows/ai-base-nvidia.yml'
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/ai-inference/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ai-base
  VARIANT: nvidia

jobs:
  build-nvidia:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        flavor: |
          latest=false
        tags: |
          # Pull request tags
          type=ref,event=pr

          # Semantic version tags for releases (v1.2.3 â†’ v1.2.3-nvidia)
          type=semver,pattern={{version}}-nvidia
          type=semver,pattern={{major}}.{{minor}}-nvidia

          # Main branch: standard tag (nvidia)
          type=raw,value=nvidia,enable=${{ github.ref == 'refs/heads/main' }}

          # Non-main branches: prototype tag (nvidia-prototype)
          type=raw,value=nvidia-prototype,enable=${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request' }}

          # SHA-based tag for tracking
          type=sha,prefix=nvidia-,suffix=-{{date 'YYYYMMDD'}},format=short

    - name: Build and push NVIDIA variant
      uses: docker/build-push-action@v5
      with:
        context: ./apps/ai-inference
        file: ./apps/ai-inference/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          ${{ steps.meta.outputs.labels }}
          variant=nvidia
          gpu_backend=cuda
          description=NVIDIA GPU optimized with CUDA
        cache-from: type=gha,scope=ai-base-nvidia
        cache-to: type=gha,mode=max,scope=ai-base-nvidia
        build-args: |
          GPU_VARIANT=nvidia
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

  test-nvidia:
    needs: build-nvidia
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull image
      run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia

    - name: Test - GPU info
      run: docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia /usr/local/bin/gpu-info

    - name: Test - Detect GPU
      run: docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia /usr/local/bin/detect-gpu

    - name: Test - Check engines
      run: |
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia bash -c "
          echo 'Checking Ollama...' && ollama --version
          echo 'Checking llama.cpp...' && ls -la /opt/ai-base/bin/llama-* | head -3
          echo 'Checking CUDA...' && [ -d /usr/local/cuda ] && echo 'CUDA toolkit present'
        "

  security-scan:
    needs: build-nvidia
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Run Trivy scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia
        format: 'sarif'
        output: 'trivy-nvidia.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-nvidia.sarif'
        category: ai-base-nvidia
