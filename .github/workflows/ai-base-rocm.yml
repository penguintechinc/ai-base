name: Build AI Base - ROCm

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/ai-inference/**'
      - '.github/workflows/ai-base-rocm.yml'
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/ai-inference/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ai-base
  VARIANT: rocm

jobs:
  build-rocm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        flavor: |
          latest=false
        tags: |
          # Pull request tags
          type=ref,event=pr

          # Semantic version tags for releases (v1.2.3 â†’ v1.2.3-rocm)
          type=semver,pattern={{version}}-rocm
          type=semver,pattern={{major}}.{{minor}}-rocm

          # Main branch: standard tag (rocm)
          type=raw,value=rocm,enable=${{ github.ref == 'refs/heads/main' }}

          # Non-main branches: prototype tag (rocm-prototype)
          type=raw,value=rocm-prototype,enable=${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') && github.event_name != 'pull_request' }}

          # SHA-based tag for tracking
          type=sha,prefix=rocm-,suffix=-{{date 'YYYYMMDD'}},format=short

    - name: Build and push ROCm variant
      uses: docker/build-push-action@v5
      with:
        context: ./apps/ai-inference
        file: ./apps/ai-inference/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          ${{ steps.meta.outputs.labels }}
          variant=rocm
          gpu_backend=rocm
          description=AMD GPU optimized with ROCm
        cache-from: type=gha,scope=ai-base-rocm
        cache-to: type=gha,mode=max,scope=ai-base-rocm
        build-args: |
          GPU_VARIANT=rocm
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

  test-rocm:
    needs: build-rocm
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull image
      run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rocm

    - name: Test - GPU info
      run: docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rocm /usr/local/bin/gpu-info

    - name: Test - Detect GPU
      run: docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rocm /usr/local/bin/detect-gpu

    - name: Test - Check engines
      run: |
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rocm bash -c "
          echo 'Checking Ollama...' && ollama --version
          echo 'Checking llama.cpp...' && ls -la /opt/ai-base/bin/llama-* | head -3
          echo 'Checking ROCm...' && [ -d /opt/rocm ] && echo 'ROCm toolkit present'
        "

  security-scan:
    needs: build-rocm
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
    - name: Run Trivy scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:rocm
        format: 'sarif'
        output: 'trivy-rocm.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-rocm.sarif'
        category: ai-base-rocm
